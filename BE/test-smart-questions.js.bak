const axios = require("axios");

const BASE_URL = "http://localhost:8001";

async function testSmartQuestions() {
  console.log("ğŸ§ª Testing Smart Follow-up Questions Generation\n");

  const testCases = [
    {
      name: "Toyota Camry Engine Noise",
      data: {
        carType: "Toyota",
        carModel: "Camry",
        mileage: "150000",
        problemDescription: "Ø£Ø³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
      },
    },
    {
      name: "Dodge Charger Transmission Issue",
      data: {
        carType: "Dodge",
        carModel: "Charger",
        mileage: "80000",
        problemDescription: "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù†Ø§Ù‚Ù„ Ø§Ù„Ø­Ø±ÙƒØ© - Ù„Ø§ ÙŠÙ†ØªÙ‚Ù„ Ù„Ù„ØªØ±Ø³ Ø§Ù„Ø«Ø§Ù„Ø«",
      },
    },
    {
      name: "Nissan Altima Brake Problem",
      data: {
        carType: "Nissan",
        carModel: "Altima",
        mileage: "120000",
        problemDescription: "Ø§Ù„ÙØ±Ø§Ù…Ù„ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ - ØªØ­ØªØ§Ø¬ Ù‚ÙˆØ© Ø£ÙƒØ¨Ø± Ù„Ù„Ø¶ØºØ·",
      },
    },
  ];

  for (let i = 0; i < testCases.length; i++) {
    const testCase = testCases[i];
    console.log(`\nğŸ“‹ Test Case ${i + 1}: ${testCase.name}`);
    console.log("=".repeat(50));

    try {
      const response = await axios.post(
        `${BASE_URL}/api/analyze-guided`,
        testCase.data
      );

      if (response.data.success) {
        console.log("âœ… Initial analysis successful");
        console.log("ğŸ” Generated Questions:");

        response.data.followUpQuestions.forEach((question, index) => {
          console.log(`  ${index + 1}. ${question.question}`);
        });

        console.log(`\nâ° Timestamp: ${response.data.timestamp}`);
        console.log(
          `ğŸ†” Session ID: ${
            response.data.followUpQuestions[0]?.timestamp || "N/A"
          }`
        );
      } else {
        console.log("âŒ Failed to get analysis:", response.data.message);
      }
    } catch (error) {
      console.log("âŒ Error:", error.response?.data?.message || error.message);
    }

    // Wait between tests to avoid rate limiting
    if (i < testCases.length - 1) {
      console.log("\nâ³ Waiting 2 seconds before next test...");
      await new Promise((resolve) => setTimeout(resolve, 2000));
    }
  }

  console.log("\n\nğŸ§ª Testing Additional Questions Generation");
  console.log("=".repeat(50));

  // Test additional questions generation
  try {
    const additionalQuestionsData = {
      carDetails: {
        carType: "Toyota",
        carModel: "Camry",
        mileage: "150000",
        lastServiceType: "ØªØºÙŠÙŠØ± Ø§Ù„Ø²ÙŠØª",
      },
      problemDescription: "Ø£Ø³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
      previousQuestions: [
        { id: "1", question: "Ù‡Ù„ ØªØ³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±ÙƒØŸ" },
        { id: "2", question: "Ù…ØªÙ‰ Ø¨Ø¯Ø£Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ" },
        { id: "3", question: "Ù‡Ù„ ØªØ²Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø§Ø±Ø¹ØŸ" },
      ],
      previousAnswers: [
        { id: "1", answer: "Ù†Ø¹Ù…ØŒ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© ÙˆØ§Ø¶Ø­" },
        { id: "2", answer: "Ù…Ù†Ø° Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†" },
        { id: "3", answer: "Ù†Ø¹Ù…ØŒ ÙŠØ²Ø¯Ø§Ø¯ Ù…Ø¹ Ø§Ù„Ø³Ø±Ø¹Ø©" },
      ],
    };

    const additionalResponse = await axios.post(
      `${BASE_URL}/api/generate-questions`,
      additionalQuestionsData
    );

    if (additionalResponse.data.success) {
      console.log("âœ… Additional questions generated successfully");
      console.log("ğŸ” Additional Questions:");

      additionalResponse.data.questions.forEach((question, index) => {
        console.log(`  ${index + 1}. ${question.question}`);
      });

      console.log(`\nâ° Timestamp: ${additionalResponse.data.timestamp}`);
      console.log(`ğŸ“ Note: ${additionalResponse.data.note}`);
    } else {
      console.log(
        "âŒ Failed to generate additional questions:",
        additionalResponse.data.message
      );
    }
  } catch (error) {
    console.log(
      "âŒ Error generating additional questions:",
      error.response?.data?.message || error.message
    );
  }

  console.log("\n\nğŸ¯ Test Summary:");
  console.log("=".repeat(30));
  console.log("âœ… Smart questions should be different for each car/problem");
  console.log("âœ… Questions should include timestamps to prevent caching");
  console.log("âœ… Additional questions should be based on previous answers");
  console.log("âœ… No duplicate questions should be generated");
  console.log("âœ… All questions should be in Arabic");
}

// Run the test
testSmartQuestions().catch(console.error);
