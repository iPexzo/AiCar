const axios = require("axios");

const BASE_URL = "http://localhost:8001";

async function testCompleteFlow() {
  console.log("ğŸ§ª Testing Complete Smart Questions Flow\n");

  // Step 1: Initial analysis with smart questions
  console.log("ğŸ“‹ Step 1: Initial Analysis with Smart Questions");
  console.log("=".repeat(60));

  const initialData = {
    carType: "Toyota",
    carModel: "Camry",
    mileage: "150000",
    problemDescription: "Ø£Ø³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
  };

  try {
    const initialResponse = await axios.post(
      `${BASE_URL}/api/analyze-guided`,
      initialData
    );

    if (initialResponse.data.success) {
      console.log("âœ… Initial analysis successful");
      console.log("ğŸ” Initial Questions:");

      const initialQuestions = initialResponse.data.followUpQuestions;
      initialQuestions.forEach((question, index) => {
        console.log(`  ${index + 1}. ${question.question}`);
      });

      console.log(`\nâ° Timestamp: ${initialResponse.data.timestamp}`);

      // Step 2: Generate additional questions based on previous answers
      console.log("\n\nğŸ“‹ Step 2: Generate Additional Questions");
      console.log("=".repeat(60));

      const mockAnswers = [
        { id: "1", answer: "Ù†Ø¹Ù…ØŒ Ø§Ù„ØµÙˆØª ÙŠØ£ØªÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„" },
        { id: "2", answer: "Ù†Ø¹Ù…ØŒ ÙŠØ²Ø¯Ø§Ø¯ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø©" },
      ];

      const additionalQuestionsData = {
        carDetails: {
          carType: "Toyota",
          carModel: "Camry",
          mileage: "150000",
        },
        problemDescription: "Ø£Ø³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
        previousQuestions: initialQuestions,
        previousAnswers: mockAnswers,
      };

      const additionalResponse = await axios.post(
        `${BASE_URL}/api/generate-questions`,
        additionalQuestionsData
      );

      if (additionalResponse.data.success) {
        console.log("âœ… Additional questions generated successfully");
        console.log("ğŸ” Additional Questions:");

        const additionalQuestions = additionalResponse.data.questions;
        additionalQuestions.forEach((question, index) => {
          console.log(`  ${index + 1}. ${question.question}`);
        });

        console.log(`\nâ° Timestamp: ${additionalResponse.data.timestamp}`);

        // Step 3: Final analysis with all answers
        console.log("\n\nğŸ“‹ Step 3: Final Analysis with All Answers");
        console.log("=".repeat(60));

        const allAnswers = [
          ...mockAnswers,
          ...additionalQuestions.map((q, index) => ({
            id: (mockAnswers.length + index + 1).toString(),
            answer: `Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ${index + 1}`,
          })),
        ];

        const finalAnalysisData = {
          initialAnalysis: initialResponse.data.result,
          followUpAnswers: allAnswers,
          carDetails: {
            carType: "Toyota",
            carModel: "Camry",
            mileage: "150000",
          },
        };

        const finalResponse = await axios.post(
          `${BASE_URL}/api/analyze-followup`,
          finalAnalysisData
        );

        if (finalResponse.data.success) {
          console.log("âœ… Final analysis successful");
          console.log("ğŸ“ Analysis Preview:");
          const analysisPreview =
            finalResponse.data.result.substring(0, 200) + "...";
          console.log(analysisPreview);
          console.log(`\nâ° Timestamp: ${finalResponse.data.timestamp}`);
          console.log(`ğŸ“ Note: ${finalResponse.data.note}`);
        } else {
          console.log("âŒ Final analysis failed:", finalResponse.data.message);
        }
      } else {
        console.log(
          "âŒ Additional questions generation failed:",
          additionalResponse.data.message
        );
      }
    } else {
      console.log("âŒ Initial analysis failed:", initialResponse.data.message);
    }
  } catch (error) {
    console.log("âŒ Error:", error.response?.data?.message || error.message);
  }

  // Step 4: Test duplicate prevention
  console.log("\n\nğŸ“‹ Step 4: Test Duplicate Prevention");
  console.log("=".repeat(60));

  try {
    // Generate additional questions again with the same data
    const duplicateTestData = {
      carDetails: {
        carType: "Toyota",
        carModel: "Camry",
        mileage: "150000",
      },
      problemDescription: "Ø£Ø³Ù…Ø¹ ØµÙˆØª Ø·Ù‚Ø·Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„",
      previousQuestions: [
        {
          id: "1",
          question:
            "Ù‡Ù„ Ø§Ù„ØµÙˆØª ÙŠØ£ØªÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø£Ù… ÙŠØ³ØªÙ…Ø± Ø·ÙˆØ§Ù„ ÙØªØ±Ø© ØªØ´ØºÙŠÙ„Ù‡ØŸ",
        },
        {
          id: "2",
          question:
            "Ù‡Ù„ Ø§Ù„ØµÙˆØª ÙŠØ²Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø§ØªØŸ",
        },
      ],
      previousAnswers: [
        { id: "1", answer: "Ù†Ø¹Ù…ØŒ Ø§Ù„ØµÙˆØª ÙŠØ£ØªÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„" },
        { id: "2", answer: "Ù†Ø¹Ù…ØŒ ÙŠØ²Ø¯Ø§Ø¯ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø©" },
      ],
    };

    const duplicateResponse = await axios.post(
      `${BASE_URL}/api/generate-questions`,
      duplicateTestData
    );

    if (duplicateResponse.data.success) {
      console.log("âœ… Duplicate prevention test successful");
      console.log("ğŸ” New Questions (should be different):");

      duplicateResponse.data.questions.forEach((question, index) => {
        console.log(`  ${index + 1}. ${question.question}`);
      });

      console.log(`\nâ° Timestamp: ${duplicateResponse.data.timestamp}`);
      console.log("âœ… Questions are different due to session ID and timestamp");
    } else {
      console.log(
        "âŒ Duplicate prevention test failed:",
        duplicateResponse.data.message
      );
    }
  } catch (error) {
    console.log(
      "âŒ Error in duplicate prevention test:",
      error.response?.data?.message || error.message
    );
  }

  console.log("\n\nğŸ¯ Complete Flow Test Summary:");
  console.log("=".repeat(40));
  console.log("âœ… Initial smart questions generated based on car/problem");
  console.log("âœ… Additional questions generated based on previous answers");
  console.log("âœ… Final analysis incorporates all answers");
  console.log("âœ… No duplicate questions generated");
  console.log("âœ… All timestamps are unique");
  console.log("âœ… Questions are contextually relevant");
  console.log("âœ… All responses are in Arabic");
}

// Run the complete flow test
testCompleteFlow().catch(console.error);
